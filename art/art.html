<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Developers</title>
	<meta name="generator" content="TextMate http://macromates.com/">
	<meta name="author" content="pro">
	<!-- Date: 2014-09-24 -->
</head>
<body>
     <center><h1>基于Art的虚拟机壳</h1></center>
     <h3>项目方案：</h3>
     <li>1.替换apk中的dex文件为oat文件</li>  
     <br>
     &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;具体实现：先把一个apk文件运行在一个art平台上，提取运行后的oat文件，然后把oat替换原来apk包中的dex文件，重新打包成apk，看能否运行；<br>
     <font color="red" >Error:<img src="art_error.png" width="200px" height="20px"/></font>
      <br>
     <font color="blue">安装失败原因探索：<br>
     	/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java源码中存在这样一段验证:<br>
     	<img src="art_error_reason.png" width="500px" height="100px"/>
     </font><br>
     从这个结果看来，apk中必须存在一个dex文件，否则无法无法绕过这段框架的代码而抛出异常；
      <br>
     <br>
   <li>2.art下的动态加载</li>
   <br>
   &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dalvik模式下的动态加载加载的是一个dex文件，那么如果在art模式下，动态加载dex还可以吗，貌似不行，因为art模式下，dex文件在安装的时候被编译成了art指令，<br>这时候如果再加载一个dex，除非系统能够自动把这个dex编译成art，否则应该是执行不了的，那么就需要人工地去编译dex成为art文件，然后再把这个art文件放在apk中，<br>这样运行的时候应该就能做到动态加载了
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;a.验证art模式下动态加载dex的可行性<br>
  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;测试结果：可行。<br>
  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;可以证明在art模式下，动态加载一个dex文件也是可以运行的，于是又把前面的加壳方案<br>
  在art模式下运行了下，还是可以运行的，所以这里暂时猜测有两种可能：<br>
  1.在动态加载dex的过程中对dex做了一个即时编译，编译成oat文件后再由art虚拟机来运行<br>
  2.在动态加载的过程中做的不是即时编译，而是对dex的解释，也就是art虚拟机中其实还保留了一部分对dex解释的功能
  
 
     <br>
     <br>
   <li>3.伪指令替换原指令，定制虚拟机运行</li>
   <br>
   &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;用编译器llvm将dex编译成一套伪指令的oat文件，然后定制一个自己的art虚拟机来解释这种伪指令的oat文件；
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<div><img src="art.png" width="600px" height="150px"/></div>

   <br>
   <br>
  <li></li>
    </body>
  </html>
